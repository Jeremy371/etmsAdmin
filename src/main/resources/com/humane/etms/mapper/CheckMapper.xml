<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.humane.etms.mapper.CheckMapper">

    <select id="send" resultType="com.humane.etms.dto.StatusDto">
        SELECT admission.admission_nm,
        attend.type_nm,
        attend.attend_nm,
        attend.attend_date,
        attend.attend_time,
        hall.head_nm,
        hall.bldg_nm,
        hall.hall_nm,
        attend_device.device_no,
        CASE WHEN attend_device.send_dttm IS NULL THEN FALSE ELSE TRUE END AS is_send,
        attend_device.send_dttm
        FROM attend_hall
        INNER JOIN attend ON attend.attend_cd = attend_hall.attend_cd
        INNER JOIN attend_map ON attend_map.attend_cd = attend.attend_cd
        INNER JOIN hall ON attend_hall.hall_cd = hall.hall_cd
        INNER JOIN admission ON attend.admission_cd = admission.admission_cd
        LEFT JOIN attend_device ON attend_hall.hall_cd = attend_device.hall_cd AND attend.attend_cd = attend_device.attend_cd
        <where>
            <if test="param != null">
                <if test="param.admissionNm != null">AND admission.admission_nm = #{param.admissionNm}</if>
                <if test="param.typeNm != null">AND attend.type_nm = #{param.typeNm}</if>
                <if test="param.attendDate != null">AND attend.attend_date = #{param.attendDate}</if>
                <if test="param.attendTime != null">AND attend.attend_time = DATE_FORMAT(#{param.attendTime}, '%T')</if>
                <if test="param.attendNm != null">AND attend.attend_nm LIKE '%' #{param.attendNm} '%'</if>
                <if test="param.headNm != null">AND hall.head_nm = #{param.headNm}</if>
                <if test="param.bldgNm != null">AND hall.bldg_nm = #{param.bldgNm}</if>
                <if test="param.hallNm != null">AND hall.hall_nm = #{param.hallNm}</if>
                <if test="param.deviceNo != null">AND attend_device.device_no = #{param.deviceNo}</if>
                <if test="param.isSend != null">
                    <if test="param.isSend == true">AND attend_device.send_dttm IS NOT NULL</if>
                    <if test="param.isSend == false">AND attend_device.send_dttm IS NULL</if>
                </if>
                <if test="param.userAdmissions != null">AND attend.admission_cd IN (${param.userAdmissions})</if>
            </if>
        </where>
        GROUP BY
        admission.admission_nm,
        attend.type_nm,
        attend.attend_nm,
        attend.attend_date,
        attend.attend_time,
        hall.head_nm,
        hall.bldg_nm,
        hall.hall_nm,
        attend_device.device_no,
        attend_device.send_dttm
    </select>

    <select id="device" resultType="com.humane.etms.dto.StatusDto">
        SELECT admission.admission_nm,
        attend.type_nm,
        attend.attend_nm,
        attend.attend_date,
        attend.attend_time,
        attend_device.device_no,
        device.uuid,
        device.phone_no,
        hall.head_nm,
        hall.bldg_nm,
        hall.hall_nm,
        device.reg_dttm,
        attend_device.send_dttm
        FROM attend
        INNER JOIN attend_device ON attend_device.attend_cd = attend.attend_cd AND attend.attend_cd = attend_device.attend_cd
        INNER JOIN admission ON attend.admission_cd = admission.admission_cd
        INNER JOIN attend_map ON attend_map.attend_cd = attend.attend_cd
        INNER JOIN hall ON attend_device.hall_cd = hall.hall_cd
        INNER JOIN device ON attend_device.device_no = device.device_no
        <where>
            <if test="param != null">
                <if test="param.admissionNm != null">AND admission.admission_nm = #{param.admissionNm}</if>
                <if test="param.typeNm != null">AND attend.type_nm = #{param.typeNm}</if>
                <if test="param.attendDate != null">AND attend.attend_date = #{param.attendDate}</if>
                <if test="param.attendTime != null">AND attend.attend_time = DATE_FORMAT(#{param.attendTime}, '%T')</if>
                <if test="param.headNm != null">AND hall.head_nm = #{param.headNm}</if>
                <if test="param.bldgNm != null">AND hall.bldg_nm = #{param.bldgNm}</if>
                <if test="param.hallNm != null">AND hall.hall_nm = #{param.hallNm}</if>
                <if test="param.deviceNo != null">AND attend_device.device_no LIKE '%' #{param.deviceNo} '%'</if>
                <if test="param.userAdmissions != null">AND attend.admission_cd IN (${param.userAdmissions})</if>
            </if>
        </where>
        GROUP BY
        admission.admission_nm,
        attend.type_nm,
        attend.attend_nm,
        attend.attend_date,
        attend.attend_time,
        attend_device.device_no,
        device.uuid,
        device.phone_no,
        hall.head_nm,
        hall.bldg_nm,
        hall.hall_nm,
        device.reg_dttm,
        attend_device.send_dttm
    </select>

    <select id="signature" resultType="com.humane.etms.dto.StatusDto">
        SELECT admission.admission_nm
             , attend.attend_cd, attend.type_nm, attend.attend_date, attend.attend_time
             , hall.hall_cd, hall.head_nm, hall.bldg_nm, hall.hall_nm
             , CASE WHEN attend_hall.sign_dttm IS NULL THEN 0 ELSE 1 END AS is_signature
             , attend_hall.sign_dttm
          FROM attend_hall
         INNER JOIN attend ON attend_hall.attend_cd = attend.attend_cd
         INNER JOIN admission ON attend.admission_cd = admission.admission_cd
         INNER JOIN hall ON attend_hall.hall_cd = hall.hall_cd
        <where>
            <if test="param != null">
                <if test="param.admissionNm != null">AND admission.admission_nm = #{param.admissionNm}</if>
                <if test="param.typeNm != null">AND attend.type_nm = #{param.typeNm}</if>
                <if test="param.attendDate != null">AND attend.attend_date = #{param.attendDate}</if>
                <if test="param.attendTime != null">AND attend.attend_time = DATE_FORMAT(#{param.attendTime}, '%T')</if>
                <if test="param.headNm != null">AND hall.head_nm = #{param.headNm}</if>
                <if test="param.bldgNm != null">AND hall.bldg_nm = #{param.bldgNm}</if>
                <if test="param.hallNm != null">AND hall.hall_nm = #{param.hallNm}</if>
                <if test="param.isSignature != null">
                    <if test="param.isSignature == true">AND attend_hall.sign_dttm IS NOT NULL</if>
                    <if test="param.isSignature == false">AND attend_hall.sign_dttm IS NULL</if>
                </if>
                <if test="param.userAdmissions != null">AND attend.admission_cd IN (${param.userAdmissions})</if>
            </if>
        </where>
    </select>
</mapper>
